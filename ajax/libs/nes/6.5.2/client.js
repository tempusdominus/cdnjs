'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};(function(a,b){'object'===('undefined'==typeof exports?'undefined':_typeof(exports))&&'object'===('undefined'==typeof module?'undefined':_typeof(module))?module.exports=b():'function'==typeof define&&define.amd?define(b):'object'===('undefined'==typeof exports?'undefined':_typeof(exports))?exports.nes=b():a.nes=b()})('undefined'==typeof window?global:window,function(){var a=function(){},b=function(a,b){var c=null,d=null;try{c=JSON.parse(a)}catch(a){d=new e(a,'protocol')}return b(d,c)},c=function(a,b){var c=null,d=null;try{c=JSON.stringify(a)}catch(a){d=new e(a,'user')}return b(d,c)},d=function(a){return function(b){setTimeout(function(){return a(b)},0)}},e=function(a,b){return'string'==typeof a&&(a=new Error(a)),a.type=b,a},f={1000:'Normal closure',1001:'Going away',1002:'Protocol error',1003:'Unsupported data',1004:'Reserved',1005:'No status received',1006:'Abnormal closure',1007:'Invalid frame payload data',1008:'Policy violation',1009:'Message too big',1010:'Mandatory extension',1011:'Internal server error',1015:'TLS handshake'},g=function(b,c){c=c||{},this._url=b,this._settings=c,this._heartbeatTimeout=!1,this._ws=null,this._reconnection=null,this._reconnectionTimer=null,this._ids=0,this._requests={},this._subscriptions={},this._heartbeat=null,this._packets=[],this._disconnectListeners=null,this._disconnectRequested=!1,this.onError=function(a){return console.error(a)},this.onConnect=a,this.onDisconnect=a,this.onUpdate=a,this.id=null};return g.WebSocket='undefined'==typeof WebSocket?null:WebSocket,g.prototype.connect=function(a,b){return'function'==typeof a&&(b=arguments[0],a={}),this._reconnection?d(b)(new Error('Cannot connect while client attempts to reconnect')):this._ws?d(b)(new Error('Already connected')):void(this._reconnection=!1===a.reconnect?null:{wait:0,delay:a.delay||1e3,maxDelay:a.maxDelay||5e3,retries:a.retries||Infinity,settings:{auth:a.auth,timeout:a.timeout}},this._connect(a,!0,b))},g.prototype._connect=function(a,b,c){var d=this,h=new g.WebSocket(this._url,this._settings.ws);this._ws=h,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var i=function(a){if(c){var b=c;return c=null,b(a)}return d.onError(a)},j=a.timeout?setTimeout(function timeoutHandler(){if(d._cleanup(),i(new e('Connection timed out','timeout')),b)return d._reconnect()},a.timeout):null;h.onopen=function(){return clearTimeout(j),h.onopen=null,d._hello(a.auth,function(a){return a?(a.path&&delete d._subscriptions[a.path],d._disconnect(function(){return i(a)},!0)):(d.onConnect(),i())})},h.onerror=function(){clearTimeout(j),d._cleanup();var a=new e('Socket error','ws');return i(a)},h.onclose=function(a){h.onopen&&i(new Error('Connection terminated while waiting to connect'));var b=d._disconnectRequested;d._cleanup();var c={code:a.code,explanation:f[a.code]||'Unknown',reason:a.reason,wasClean:a.wasClean,willReconnect:!!(d._reconnection&&1<=d._reconnection.retries),wasRequested:b};d.onDisconnect(c.willReconnect,c),d._reconnect()},h.onmessage=function(a){return d._onMessage(a)}},g.prototype.overrideReconnectionAuth=function(a){return!!this._reconnection&&(this._reconnection.settings.auth=a,!0)},g.prototype.disconnect=function(b){return b=b||a,this._disconnect(b,!1)},g.prototype._disconnect=function(a,b){this._reconnection=null,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var c=this._disconnectRequested||!b;return this._disconnectListeners?(this._disconnectRequested=c,void this._disconnectListeners.push(a)):this._ws&&(this._ws.readyState===g.WebSocket.OPEN||this._ws.readyState===g.WebSocket.CONNECTING)?void(this._disconnectRequested=c,this._disconnectListeners=[a],this._ws.close()):d(a)()},g.prototype._cleanup=function(){this._ws&&((this._ws.readyState===g.WebSocket.OPEN||this._ws.readyState===g.WebSocket.CONNECTING)&&this._ws.close(),this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=a,this._ws.onmessage=null,this._ws=null),this._packets=[],this.id=null,clearTimeout(this._heartbeat),this._heartbeat=null;for(var b=new e('Request failed - server disconnected','disconnect'),c=Object.keys(this._requests),d=0;d<c.length;++d){var f=c[d],h=this._requests[f],i=h.callback;clearTimeout(h.timeout),delete this._requests[f],i(b)}if(this._disconnectListeners){var j=this._disconnectListeners;this._disconnectListeners=null,this._disconnectRequested=!1,j.forEach(function(a){return a()})}},g.prototype._reconnect=function(){var b=this;if(this._reconnection){if(1>this._reconnection.retries)return this._disconnect(a,!0);--this._reconnection.retries,this._reconnection.wait+=this._reconnection.delay;var c=Math.min(this._reconnection.wait,this._reconnection.maxDelay);this._reconnectionTimer=setTimeout(function(){b._connect(b._reconnection.settings,!1,function(a){if(a)return b.onError(a),b._reconnect()})},c)}},g.prototype.request=function(a,b){'string'==typeof a&&(a={method:'GET',path:a});var c={type:'request',method:a.method||'GET',path:a.path,headers:a.headers,payload:a.payload};return this._send(c,!0,b)},g.prototype.message=function(a,b){return this._send({type:'message',message:a},!0,b)},g.prototype._send=function(b,f,h){var i=this;return h=h||a,this._ws&&this._ws.readyState===g.WebSocket.OPEN?void(b.id=++this._ids,c(b,function(a,c){if(a)return d(h)(a);if(!f)try{return i._ws.send(c)}catch(a){return d(h)(new e(a,'ws'))}var g={callback:h,timeout:null};i._settings.timeout&&(g.timeout=setTimeout(function(){return g.callback=null,g.timeout=null,h(new e('Request timed out','timeout'))},i._settings.timeout)),i._requests[b.id]=g;try{i._ws.send(c)}catch(a){return clearTimeout(i._requests[b.id].timeout),delete i._requests[b.id],d(h)(new e(a,'ws'))}})):d(h)(new e('Failed to send message - server disconnected','disconnect'))},g.prototype._hello=function(a,b){var c={type:'hello',version:'2'};a&&(c.auth=a);var d=this.subscriptions();return d.length&&(c.subs=d),this._send(c,!0,b)},g.prototype.subscriptions=function(){return Object.keys(this._subscriptions)},g.prototype.subscribe=function(a,b,c){var f=this;if(!a||'/'!==a[0])return d(c)(new e('Invalid path','user'));var h=this._subscriptions[a];if(h)return-1===h.indexOf(b)&&h.push(b),d(c)();if(this._subscriptions[a]=[b],!this._ws||this._ws.readyState!==g.WebSocket.OPEN)return d(c)();return this._send({type:'sub',path:a},!0,function(b){return b&&delete f._subscriptions[a],c(b)})},g.prototype.unsubscribe=function(a,b,c){if(!a||'/'!==a[0])return d(c)(new e('Invalid path','user'));var f=this._subscriptions[a];if(!f)return d(c)();var h=!1;if(!b)delete this._subscriptions[a],h=!0;else{var i=f.indexOf(b);if(-1===i)return d(c)();f.splice(i,1),f.length||(delete this._subscriptions[a],h=!0)}if(!h||!this._ws||this._ws.readyState!==g.WebSocket.OPEN)return d(c)();return this._send({type:'unsub',path:a},!0,function(){return c()})},g.prototype._onMessage=function(a){var c=this;this._beat();var d=a.data,f=d[0];if('{'!==f){if(this._packets.push(d.slice(1)),'!'!==f)return;d=this._packets.join(''),this._packets=[]}this._packets.length&&(this._packets=[],this.onError(new e('Received an incomplete message','protocol'))),b(d,function(a,b){if(a)return c.onError(a);var d=null;if(b.statusCode&&400<=b.statusCode&&599>=b.statusCode&&(d=new e(b.payload.message||b.payload.error||'Error','server'),d.statusCode=b.statusCode,d.data=b.payload,d.headers=b.headers,d.path=b.path),'ping'===b.type)return c._send({type:'ping'},!1);if('update'===b.type)return c.onUpdate(b.message);if('pub'===b.type||'revoke'===b.type){var h=c._subscriptions[b.path];if('revoke'===b.type&&delete c._subscriptions[b.path],h&&void 0!==b.message){var j={};'revoke'===b.type&&(j.revoked=!0);for(var k=0;k<h.length;++k)h[k](b.message,j)}return}var f=c._requests[b.id];if(!f)return c.onError(new e('Received response for unknown request','protocol'));var g=f.callback;return clearTimeout(f.timeout),delete c._requests[b.id],g?'request'===b.type?g(d,b.payload,b.statusCode,b.headers):'message'===b.type?g(d,b.message):'hello'===b.type?(c.id=b.socket,b.heartbeat&&(c._heartbeatTimeout=b.heartbeat.interval+b.heartbeat.timeout,c._beat()),g(d)):'sub'===b.type||'unsub'===b.type?g(d):c.onError(new e('Received unknown response type: '+b.type,'protocol')):void 0})},g.prototype._beat=function(){var a=this;this._heartbeatTimeout&&(clearTimeout(this._heartbeat),this._heartbeat=setTimeout(function(){a.onError(new e('Disconnecting due to heartbeat timeout','timeout')),a._ws.close()},this._heartbeatTimeout))},{Client:g}});
